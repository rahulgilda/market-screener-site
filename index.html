<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ“ˆ Market Screener</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #0b0f14;
      color: #e6edf3;
      padding: 30px;
    }
    h1 {
      font-size: 2.15em;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #d4e2fc;
      margin-bottom: 6px;
    }
    #logbox {
      margin-top: 25px;
      background: #131921;
      padding: 18px 20px;
      border-radius: 10px;
      font-family: Consolas, monospace;
      max-height: 350px;
      overflow-y: auto;
      box-shadow: 0 0 5px rgba(255,255,255,0.08);
      font-size: 0.88rem;
      border-left: 3px solid #1f6feb;
    }
    #runBtn {
      background: #43a047;
      color: white;
      border: none;
      padding: 12px 26px;
      font-size: 1.05em;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 22px;
      transition: background 0.3s;
    }
    #runBtn:hover {
      background: #4ccf53;
    }
    #scanner-status {
      margin-top: 25px;
      display: none;
      justify-content: center;
      align-items: center;
      gap: 18px;
      background: #131921;
      padding: 18px 22px;
      border-radius: 14px;
      box-shadow: 0 0 8px rgba(255,255,255,0.05);
    }
    #scanner-status img {
      width: 40px;
      animation: pulse 1.4s infinite ease-in-out;
    }
    @keyframes pulse {
      0% { opacity: .65; }
      50% { opacity: 1; }
      100% { opacity: .65; }
    }
    #report-container {
      margin-top: 40px;
      width: 100%;
      display: none;
      background: #131921;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 0 10px rgba(255,255,255,0.08);
    }
  </style>
</head>

<body>
  <h1>ðŸ“ˆ Market Screener</h1>
  <p style="color:#8b9bab;font-size:0.95rem;margin-top:0;">Live Debit Call Spread Signals</p>

  <button id="runBtn">â–¶ Run Screener</button>

  <div id="scanner-status">
    <img src="https://raw.githubusercontent.com/rahulgilda/market-screener-site/main/icon-loading.gif" alt="loading">
    <span id="scan-text">Scanning S&P 500...</span>
  </div>

  <div id="logbox" style="display:none;"></div>

  <div id="report-container"></div>

<script>
  const runBtn = document.getElementById("runBtn");
  const logbox = document.getElementById("logbox");
  const reportBox = document.getElementById("report-container");
  const scanDiv = document.getElementById("scanner-status");
  const scanText = document.getElementById("scan-text");

  logbox.style.display = "none";
  reportBox.style.display = "none";

  let lastTimestamp = null;
  let evtSource = null;

  function addLog(msg) {
    const time = new Date().toLocaleTimeString();
    if (logbox.style.display === "none") logbox.style.display = "block";
    logbox.innerHTML = `[${time}] ${msg}<br>` + logbox.innerHTML;
  }

  async function loadReport(force=false) {
    try {
      const url = "https://rahulgilda.github.io/market-screener-site/report.html?cache=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      const html = await res.text();

      const t = html.match(/Last updated:\s*([^<]+)/);
      const ts = t ? t[1].trim() : null;

      if(!force && ts === lastTimestamp) return false;
      lastTimestamp = ts;
      
      reportBox.innerHTML = html;
      reportBox.style.display = "block";
      reportBox.scrollIntoView({ behavior: "smooth" });
      return true;
    } catch { return false; }
  }

  async function waitForNewReport() {
    let attempts = 0;
    const max = 25;

    const timer = setInterval(async () => {
      attempts++;
      const updated = await loadReport();
      if(updated) {
        clearInterval(timer);
        scanDiv.style.display = "none";
        runBtn.disabled = false;
        return;
      }
      if(attempts >= max) {
        addLog("âš  Timeout waiting for report update");
        clearInterval(timer);
        scanDiv.style.display = "none";
        runBtn.disabled = false;
      }
    }, 5000);
  }

  runBtn.onclick = async () => {
    reportBox.style.display = "none";
    logbox.style.display = "none";
    scanDiv.style.display = "flex";
    scanText.innerText = "Preparing scan...";

    runBtn.disabled = true;

    evtSource = new EventSource("https://mrt-email-screener.onrender.com/stream");

    evtSource.onmessage = (e) => {
      const msg = e.data;
      if (msg.includes("Pre-scanning")) {
        scanText.innerText = msg.replace("Pre-scanning", "Checking");
      } else if(msg.includes("Loaded")) {
        scanText.innerText = "Scanning S&P500...";
      } else if (msg.includes("Bullish setup")) {
        scanText.innerText = "âœ… Found setup: " + msg.split(":")[0];
      } else if(msg.includes("Screener complete")) {
        evtSource.close();
        scanText.innerText = "Finalizing results...";
        waitForNewReport();
      }
    };

    evtSource.onerror = () => {
      evtSource.close();
      scanDiv.style.display = "none";
      runBtn.disabled = false;
    };

    await fetch("https://mrt-email-screener.onrender.com/run");
  };
</script>

</body>
</html>
